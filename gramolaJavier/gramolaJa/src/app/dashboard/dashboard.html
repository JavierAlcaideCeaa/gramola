<div class="dashboard-container">
  
  <!-- ========== LOADING STATE ========== -->
  <div *ngIf="loading" class="loading-state">
    <div class="spinner"></div>
    <h2>Cargando dashboard...</h2>
  </div>

  <!-- ========== ERROR STATE ========== -->
  <div *ngIf="error && !loading" class="error-state">
    <div class="error-icon">âš ï¸</div>
    <h2>Error al cargar</h2>
    <p>{{ error }}</p>
    <button class="retry-button" (click)="initializeDashboard()">
      Reintentar
    </button>
  </div>

  <!-- ========== MAIN CONTENT ========== -->
  <div *ngIf="!loading && !error" class="dashboard-content">
    
    <!-- ========== HEADER ========== -->
    <header class="dashboard-header">
      <div class="header-left">
        <h1>ğŸµ {{ barName }}</h1>
        <p class="user-email">{{ userEmail }}</p>
      </div>
      <div class="header-right">
        <button class="btn-secondary" (click)="getDevices()">
          ğŸ”„ Recargar Dispositivos
        </button>
        <button class="btn-danger" (click)="logout()">
          ğŸšª Cerrar SesiÃ³n
        </button>
      </div>
    </header>

    <!-- ========== DISPOSITIVOS ========== -->
    <section class="devices-section">
      <h2>ğŸ“± Dispositivos Spotify</h2>
      
      <div *ngIf="deviceError" class="alert alert-error">
        {{ deviceError }}
      </div>

      <div class="devices-grid">
        <div 
          *ngFor="let device of devices" 
          class="device-card"
          [class.active]="device.is_active"
          [class.selected]="selectedDevice?.id === device.id"
          (click)="selectedDevice = device">
          
          <div class="device-icon">
            {{ device.type === 'Computer' ? 'ğŸ’»' : 
               device.type === 'Smartphone' ? 'ğŸ“±' : 
               device.type === 'Speaker' ? 'ğŸ”Š' : 'ğŸµ' }}
          </div>
          
          <div class="device-info">
            <h3>{{ device.name }}</h3>
            <p>{{ device.type }}</p>
            <span *ngIf="device.is_active" class="badge-active">Activo</span>
          </div>
          
          <div class="device-volume">
            <span>ğŸ”Š {{ device.volume_percent }}%</span>
          </div>
        </div>
      </div>

      <div *ngIf="devices.length === 0 && !deviceError" class="alert alert-info">
        â„¹ï¸ No hay dispositivos conectados. Abre Spotify en tu computadora o mÃ³vil.
      </div>
    </section>

    <!-- ========== LAYOUT: PLAYLISTS + COLA ========== -->
    <div class="main-layout">
      
      <!-- ========== COLUMNA IZQUIERDA: PLAYLISTS ========== -->
      <aside class="playlists-sidebar">
        <div class="sidebar-header">
          <h2>ğŸ“‚ Mis Playlists</h2>
          <button class="btn-icon" (click)="getPlaylists()" title="Recargar">
            ğŸ”„
          </button>
        </div>

        <div *ngIf="playlistError" class="alert alert-error">
          {{ playlistError }}
        </div>

        <div class="playlists-list">
          <div 
            *ngFor="let playlist of playlists"
            class="playlist-item"
            [class.selected]="selectedPlaylist?.id === playlist.id"
            (click)="requestPasswordAndSelectPlaylist(playlist)">
            
            <div class="playlist-cover">
              <img 
                *ngIf="playlist.images && playlist.images.length > 0"
                [src]="playlist.images[0].url" 
                [alt]="playlist.name">
              <div *ngIf="!playlist.images || playlist.images.length === 0" 
                   class="playlist-placeholder">
                ğŸµ
              </div>
            </div>
            
            <div class="playlist-info">
              <h3>{{ playlist.name }}</h3>
              <p>{{ playlist.tracks.total }} canciones</p>
            </div>
          </div>
        </div>

        <div *ngIf="playlists.length === 0 && !playlistError" class="alert alert-info">
          â„¹ï¸ No tienes playlists disponibles
        </div>
      </aside>

      <!-- ========== COLUMNA DERECHA: COLA ========== -->
      <main class="queue-content">
        
        <!-- ========== REPRODUCTOR ACTUAL ========== -->
        <section class="now-playing" *ngIf="currentTrack">
          <h2>â–¶ï¸ Reproduciendo Ahora</h2>
          
          <div class="now-playing-card">
            <div class="track-cover">
              <img 
                *ngIf="currentTrack.album.images && currentTrack.album.images.length > 0"
                [src]="currentTrack.album.images[0].url" 
                [alt]="currentTrack.name">
            </div>
            
            <div class="track-info">
              <h3>{{ currentTrack.name }}</h3>
              <p>{{ currentTrack.artists[0].name }}</p>
              <p class="album-name">{{ currentTrack.album.name }}</p>
            </div>

            <!-- Controles de reproducciÃ³n -->
            <div class="playback-controls">
              <button class="control-btn-main" (click)="togglePlay()" title="Play/Pause">
                {{ isPlaying ? 'â¸ï¸' : 'â–¶ï¸' }}
              </button>
            </div>

            <!-- Barra de progreso -->
            <div class="progress-bar">
              <span class="time-label">{{ formatTime(progress) }}</span>
              <div class="progress-track">
                <div class="progress-fill" [style.width.%]="getProgressPercentage()"></div>
              </div>
              <span class="time-label">{{ formatTime(duration) }}</span>
            </div>

            <!-- Control de volumen -->
            <div class="volume-control">
              <span>ğŸ”Š</span>
              <input 
                type="range" 
                min="0" 
                max="100" 
                [(ngModel)]="volume"
                (input)="changeVolume($event)"
                class="volume-slider">
              <span>{{ volume }}%</span>
            </div>
          </div>
        </section>

        <!-- ========== COLA DE REPRODUCCIÃ“N ========== -->
        <section class="queue-section">
          <div class="queue-header">
            <h2>ğŸ“‹ Cola de ReproducciÃ³n</h2>
            <span class="queue-count" *ngIf="queue.length > 0">
              {{ queue.length }} {{ queue.length === 1 ? 'canciÃ³n' : 'canciones' }}
            </span>
          </div>

          <div *ngIf="currentPlaylistError" class="alert alert-error">
            {{ currentPlaylistError }}
          </div>

          <!-- Lista de canciones en cola -->
          <div class="queue-list">
            <div 
              *ngFor="let item of queue; let i = index"
              class="queue-item">
              
              <div class="track-number">{{ i + 1 }}</div>
              
              <div class="track-cover-small">
                <img 
                  *ngIf="item.track.album.images && item.track.album.images.length > 0"
                  [src]="item.track.album.images[0].url" 
                  [alt]="item.track.name">
              </div>
              
              <div class="track-details">
                <h4>{{ item.track.name }}</h4>
                <p>{{ item.track.artists[0].name }}</p>
              </div>
              
              <div class="track-duration">
                {{ formatTime(item.track.duration_ms) }}
              </div>
              
              <div class="track-actions">
                <button 
                  class="btn-warning"
                  (click)="openQueuePaymentModal(item.track, 199)"
                  title="Adelantar en la cola">
                  âš¡ Adelantar
                </button>
              </div>
            </div>
          </div>

          <div *ngIf="queue.length === 0 && !currentPlaylistError" class="empty-state">
            <div class="empty-icon">ğŸµ</div>
            <p>No hay canciones en la cola</p>
            <p class="empty-hint">Selecciona una playlist para ver sus canciones</p>
          </div>
        </section>
      </main>
    </div>

  </div>

  <!-- ========== MODAL DE BÃšSQUEDA (FLOTANTE) ========== -->
  <div class="search-modal-overlay" *ngIf="showSearch" (click)="closeSearch()">
    <div class="search-modal" (click)="$event.stopPropagation()">
      
      <div class="search-modal-header">
        <h2>ğŸ” Buscar Canciones</h2>
        <button class="btn-close" (click)="closeSearch()" title="Cerrar">
          âœ–ï¸
        </button>
      </div>

      <div class="search-modal-body">
        
        <!-- Filtros de bÃºsqueda -->
        <div class="search-filters">
          <input 
            type="text" 
            class="search-input"
            [(ngModel)]="titleFilter" 
            placeholder="TÃ­tulo de la canciÃ³n"
            (keyup.enter)="search()"
            autofocus>
          
          <input 
            type="text" 
            class="search-input"
            [(ngModel)]="artistFilter" 
            placeholder="Artista"
            (keyup.enter)="search()">
          
          <button 
            class="btn-primary"
            (click)="search()"
            [disabled]="searching">
            {{ searching ? 'ğŸ” Buscando...' : 'ğŸ” Buscar' }}
          </button>
        </div>

        <!-- BotÃ³n limpiar -->
        <div class="search-actions" *ngIf="titleFilter || artistFilter">
          <button class="btn-secondary" (click)="clearSearch()">
            ğŸ—‘ï¸ Limpiar
          </button>
        </div>

        <!-- Mensajes de error -->
        <div *ngIf="songError" class="alert alert-error">
          {{ songError }}
        </div>

        <!-- Loading -->
        <div *ngIf="searching" class="search-loading">
          <div class="spinner-small"></div>
          <p>Buscando canciones en Spotify...</p>
        </div>

        <!-- Resultados -->
        <div class="search-results" *ngIf="!searching && searchResults.length > 0">
          <div class="results-header">
            <h3>ğŸ“‹ {{ searchResults.length }} {{ searchResults.length === 1 ? 'resultado' : 'resultados' }}</h3>
          </div>

          <div 
            *ngFor="let track of searchResults"
            class="search-result-item">
            
            <div class="track-cover-small">
              <img 
                *ngIf="track.album.images && track.album.images.length > 0"
                [src]="track.album.images[0].url" 
                [alt]="track.name">
              <div *ngIf="!track.album.images || track.album.images.length === 0" 
                   class="track-placeholder">
                ğŸµ
              </div>
            </div>
            
            <div class="track-details">
              <h4>{{ track.name }}</h4>
              <p>{{ track.artists[0].name }}</p>
              <p class="track-album">{{ track.album.name }}</p>
              <p class="track-duration-small">{{ formatTime(track.duration_ms) }}</p>
            </div>
            
            <div class="track-actions">
              <button 
                class="btn-success"
                (click)="openQueuePaymentModal(track, 299)"
                title="AÃ±adir canciÃ³n nueva">
                ğŸµ AÃ±adir (2.99â‚¬)
              </button>
            </div>
          </div>
        </div>

        <!-- Sin resultados -->
        <div *ngIf="!searching && searchResults.length === 0 && !songError && (titleFilter || artistFilter)" 
             class="empty-search">
          <div class="empty-icon">ğŸ”</div>
          <p>No se encontraron canciones</p>
          <p class="empty-hint">Intenta con otros tÃ©rminos</p>
        </div>

        <!-- Estado inicial -->
        <div *ngIf="!searching && searchResults.length === 0 && !titleFilter && !artistFilter && !songError" 
             class="search-prompt">
          <div class="prompt-icon">ğŸµ</div>
          <h3>Busca tus canciones favoritas</h3>
          <p>Ingresa el tÃ­tulo o artista</p>
          <ul class="search-tips">
            <li>ğŸ’¡ Puedes buscar por tÃ­tulo, artista o ambos</li>
            <li>ğŸ’¡ Presiona Enter para buscar rÃ¡pidamente</li>
            <li>ğŸ’¡ Haz clic fuera del modal para cerrar</li>
          </ul>
        </div>

      </div>
    </div>
  </div>

  <!-- ========== BOTÃ“N FLOTANTE ========== -->
  <button 
    *ngIf="!showSearch && !loading && !error"
    class="fab-button"
    (click)="openSearch()"
    title="Buscar canciones">
    ğŸ”
  </button>

  <!-- ========== MODAL DE PAGO PARA COLA ========== -->
  <app-queue-payment
    *ngIf="showQueuePaymentModal && selectedTrackForQueue"
    [track]="selectedTrackForQueue"
    [deviceId]="selectedDevice?.id || ''"
    [initialPrice]="selectedPriceForQueue"
    (close)="closeQueuePaymentModal()">
  </app-queue-payment>

  <!-- ========== MODAL DE CONTRASEÃ‘A ========== -->
  <div class="password-modal-overlay" *ngIf="showPasswordModal" (click)="cancelPasswordPrompt()">
    <div class="password-modal" (click)="$event.stopPropagation()">
      <div class="password-header">
        <h3>ğŸ”’ Cambiar Playlist</h3>
        <button class="btn-close" (click)="cancelPasswordPrompt()">âœ–ï¸</button>
      </div>
      <p class="password-description">Introduce la contraseÃ±a del bar para cambiar la playlist</p>
      <input 
        type="password" 
        class="password-input"
        [(ngModel)]="passwordInput"
        (keyup.enter)="confirmPasswordPrompt()"
        placeholder="ContraseÃ±a"
        autofocus>
      <div class="password-actions">
        <button class="btn-secondary" (click)="cancelPasswordPrompt()">Cancelar</button>
        <button class="btn-primary" (click)="confirmPasswordPrompt()">âœ“ Confirmar</button>
      </div>
    </div>
  </div>

</div>