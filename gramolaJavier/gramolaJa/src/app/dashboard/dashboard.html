<div class="dashboard-container">
  
  <!-- ========== LOADING STATE ========== -->
  <div *ngIf="loading" class="loading-state">
    <div class="spinner"></div>
    <h2>Cargando Dashboard...</h2>
    <p>Conectando con Spotify</p>
  </div>

  <!-- ========== ERROR STATE ========== -->
  <div *ngIf="error && !loading" class="error-state">
    <div class="error-icon">âš ï¸</div>
    <h2>Error</h2>
    <p>{{ error }}</p>
    <button class="retry-button" (click)="logout()">
      Volver al Login
    </button>
  </div>

  <!-- ========== DASHBOARD CONTENT ========== -->
  <div *ngIf="!loading && !error" class="dashboard-content">
    
    <!-- ========== HEADER ========== -->
    <header class="dashboard-header">
      <div class="user-info">
        <div class="user-details">
          <h1>ğŸµ {{ barName }}</h1>
          <p>{{ userEmail }}</p>
        </div>
      </div>
      <button class="logout-button" (click)="logout()">
        ğŸšª Cerrar SesiÃ³n
      </button>
    </header>

    <!-- ========== MAIN CONTENT ========== -->
    <main class="dashboard-main">
      <!-- ========== DISPOSITIVOS (Figura 28) ========== -->
      <section class="card devices-card">
        <div class="card-header">
          <h3>ğŸ”Š Dispositivos</h3>
          <button class="link-btn" (click)="getDevices()">
            ğŸ”„ Recargar
          </button>
        </div>

        <!-- âœ… DISPOSITIVOS ENCONTRADOS -->
        <div *ngIf="devices.length > 0" class="list">
          <div 
            *ngFor="let device of devices"
            class="row"
            [class.active-device]="device.is_active"
            (click)="selectedDevice = device">
            
            <span class="device-content">
              <span *ngIf="device.is_active" class="music-icon">ğŸ¶</span>
              <span class="device-name">{{ device.name }}</span>
              <span class="device-separator">-</span>
              <span class="device-type">{{ device.type }}</span>
              <span class="device-separator">-</span>
              <span class="device-id">{{ device.id }}</span>
              <span *ngIf="device.is_active" class="music-icon">ğŸ¶</span>
            </span>
          </div>
        </div>

        <!-- âœ… NO HAY DISPOSITIVOS - MOSTRAR INSTRUCCIONES DETALLADAS -->
        <div *ngIf="devices.length === 0 && !deviceError" class="no-devices-section">
          <div class="warning-icon-large">âš ï¸</div>
          <h3>No hay dispositivos de Spotify conectados</h3>
          
          <div class="instructions-card">
            <h4>ğŸ“± Para reproducir mÃºsica necesitas:</h4>
            
            <div class="instruction-step">
              <div class="step-number">1</div>
              <div class="step-content">
                <h5>Descargar Spotify Desktop</h5>
                <p>Ve a <a href="https://www.spotify.com/download" target="_blank" class="spotify-download-link">spotify.com/download</a> y descarga la aplicaciÃ³n para tu computadora</p>
              </div>
            </div>

            <div class="instruction-step">
              <div class="step-number">2</div>
              <div class="step-content">
                <h5>Iniciar SesiÃ³n</h5>
                <p>Abre Spotify Desktop e inicia sesiÃ³n con <strong>{{ userEmail }}</strong></p>
              </div>
            </div>

            <div class="instruction-step">
              <div class="step-number">3</div>
              <div class="step-content">
                <h5>Reproducir Algo</h5>
                <p>Busca cualquier canciÃ³n y dale <strong>Play</strong>. Esto activa el dispositivo.</p>
              </div>
            </div>

            <div class="instruction-step">
              <div class="step-number">4</div>
              <div class="step-content">
                <h5>Recargar Dashboard</h5>
                <p>Haz clic en el botÃ³n <strong>ğŸ”„ Recargar</strong> arriba y tu dispositivo deberÃ­a aparecer.</p>
              </div>
            </div>
          </div>

          <div class="alternative-options">
            <h4>ğŸ“² Alternativas:</h4>
            <ul>
              <li><strong>MÃ³vil:</strong> Usa la app de Spotify en tu telÃ©fono</li>
              <li><strong>Tablet:</strong> Instala Spotify en tu tablet</li>
              <li><strong>Web Player:</strong> Ve a <a href="https://open.spotify.com" target="_blank">open.spotify.com</a> (limitado)</li>
            </ul>
          </div>

          <button class="refresh-devices-button" (click)="getDevices()">
            ğŸ”„ Buscar Dispositivos Nuevamente
          </button>
        </div>

        <!-- âš ï¸ ERROR AL CARGAR DISPOSITIVOS -->
        <div class="error" *ngIf="deviceError">
          âš ï¸ {{ deviceError }}
        </div>
      </section>

      <!-- ========== PLAYLISTS ========== -->
      <section class="card playlists-card">
        <div class="card-header">
          <h3>ğŸ“‚ Tus Playlists</h3>
          <button class="link-btn" (click)="getPlaylists()">
            ğŸ”„ Recargar
          </button>
        </div>

        <div *ngIf="playlists.length > 0" class="playlists-grid">
          <div 
            *ngFor="let playlist of playlists"
            class="playlist-card"
            [class.selected]="selectedPlaylist?.id === playlist.id"
            (click)="selectPlaylist(playlist)">
            
            <img 
              [src]="playlist.images[0]?.url || 'https://via.placeholder.com/200'" 
              [alt]="playlist.name"
              class="playlist-image"
            >
            
            <div class="playlist-info">
              <h4 class="playlist-name">{{ playlist.name }}</h4>
              <p class="playlist-tracks">{{ playlist.tracks.total }} canciones</p>
            </div>
          </div>
        </div>

        <div class="error" *ngIf="playlistError">
          âš ï¸ {{ playlistError }}
        </div>
      </section>

      <!-- ========== COLA DE REPRODUCCIÃ“N (queue - Figura 26) ========== -->
      <section *ngIf="selectedPlaylist && queue.length > 0" class="card queue-card">
        <div class="card-header">
          <h3>ğŸµ Cola de ReproducciÃ³n</h3>
          <p class="subtitle">{{ queue.length }} canciones en {{ selectedPlaylist.name }}</p>
        </div>

        <div class="queue-list">
          <div 
            *ngFor="let item of queue; let i = index"
            class="queue-item">
            
            <span class="queue-number">{{ i + 1 }}</span>
            
            <img 
              [src]="item.track.album.images[2]?.url || item.track.album.images[0]?.url" 
              [alt]="item.track.name"
              class="queue-track-image"
            >
            
            <div class="queue-track-info">
              <div class="queue-track-name">{{ item.track.name }}</div>
              <div class="queue-track-artist">{{ item.track.artists[0].name }}</div>
            </div>
            
            <div class="queue-track-duration">
              {{ formatTime(item.track.duration_ms) }}
            </div>
          </div>
        </div>

        <div class="error" *ngIf="currentPlaylistError">
          âš ï¸ {{ currentPlaylistError }}
        </div>
      </section>

      <!-- ========== REPRODUCCIÃ“N ACTUAL ========== -->
      <section *ngIf="currentTrack" class="card player-card">
        <h3>ğŸ§ Reproduciendo Ahora</h3>
        
        <div class="now-playing">
          <img 
            [src]="currentTrack.album.images[0]?.url" 
            [alt]="currentTrack.name"
            class="album-cover"
          >
          
          <div class="track-details">
            <h2 class="current-track-name">{{ currentTrack.name }}</h2>
            <h3 class="current-artist-name">{{ currentTrack.artists[0].name }}</h3>
            <p class="current-album-name">{{ currentTrack.album.name }}</p>
          </div>
        </div>

        <!-- Progress Bar -->
        <div class="progress-bar">
          <span class="time-label">{{ formatTime(progress) }}</span>
          <div class="progress-track">
            <div class="progress-fill" [style.width.%]="getProgressPercentage()"></div>
          </div>
          <span class="time-label">{{ formatTime(duration) }}</span>
        </div>

        <!-- Controls -->
        <div class="player-controls">
          <button class="control-button" (click)="previousTrack()" title="Anterior">
            â®ï¸
          </button>
          <button class="control-button play-button" (click)="togglePlay()" title="Play/Pause">
            {{ isPlaying ? 'â¸ï¸' : 'â–¶ï¸' }}
          </button>
          <button class="control-button" (click)="nextTrack()" title="Siguiente">
            â­ï¸
          </button>
        </div>

        <!-- Volume -->
        <div class="volume-control">
          <span class="volume-icon">ğŸ”‰</span>
          <input 
            type="range" 
            min="0" 
            max="100" 
            [value]="volume"
            (input)="changeVolume($event)"
            class="volume-slider"
            title="Volumen"
          >
          <span class="volume-value">{{ volume }}%</span>
        </div>
      </section>

      <!-- ========== BÃšSQUEDA AVANZADA (Figura 26) ========== -->
      <section class="card search-card">
        <h3>ğŸ” Buscar Canciones</h3>
        
        <!-- BÃºsqueda General -->
        <div class="search-box">
          <input 
            type="text" 
            placeholder="Buscar canciones, artistas o Ã¡lbumes..."
            [(ngModel)]="searchQuery"
            (keyup.enter)="search()"
            class="search-input"
          >
          <button 
            class="search-button" 
            (click)="search()"
            [disabled]="searching">
            {{ searching ? 'ğŸ”„ Buscando...' : 'ğŸ” Buscar' }}
          </button>
        </div>

        <!-- Filtros Avanzados (title y artist - Figura 26) -->
        <div class="advanced-filters">
          <h4>ğŸ¯ Filtros Avanzados</h4>
          
          <div class="filter-row">
            <div class="filter-group">
              <label for="title-filter">ğŸµ TÃ­tulo de la canciÃ³n:</label>
              <input 
                id="title-filter"
                type="text" 
                [(ngModel)]="titleFilter"
                placeholder="Ej: Lost"
                class="filter-input"
                (keyup.enter)="search()"
              >
            </div>
            
            <div class="filter-group">
              <label for="artist-filter">ğŸ¤ Artista:</label>
              <input 
                id="artist-filter"
                type="text" 
                [(ngModel)]="artistFilter"
                placeholder="Ej: LP"
                class="filter-input"
                (keyup.enter)="search()"
              >
            </div>
          </div>

          <button 
            class="filter-search-button" 
            (click)="search()"
            [disabled]="searching">
            {{ searching ? 'ğŸ”„ Buscando...' : 'ğŸ” Buscar con Filtros' }}
          </button>
        </div>

        <!-- Resultados de BÃºsqueda (tracks - Figura 26) -->
        <div *ngIf="searchResults.length > 0" class="search-results">
          <h4>ğŸ“‹ Resultados ({{ searchResults.length }})</h4>
          
          <div class="results-list">
            <div 
              *ngFor="let track of searchResults; let i = index"
              class="result-item">
              
              <span class="result-number">{{ i + 1 }}</span>
              
              <img 
                [src]="track.album.images[2]?.url || track.album.images[0]?.url" 
                [alt]="track.name"
                class="result-image"
              >
              
              <div class="result-info">
                <h5 class="result-track-name">{{ track.name }}</h5>
                <p class="result-artist-name">{{ track.artists[0].name }}</p>
                <p class="result-album-name">{{ track.album.name }}</p>
              </div>
              
              <div class="result-actions">
                <button 
                  class="play-now-button"
                  (click)="playTrack(track)"
                  title="Reproducir ahora">
                  â–¶ï¸ Reproducir
                </button>
                <button 
                  class="add-queue-button"
                  (click)="addToQueue(track)"
                  title="AÃ±adir a la cola">
                  â• Cola
                </button>
              </div>
            </div>
          </div>
        </div>
        <!-- Modal de Queue Payment -->
        <app-queue-payment
          *ngIf="showQueuePaymentModal"
          [track]="selectedTrackForQueue"
          [deviceId]="selectedDevice?.id || ''"
          (close)="closeQueuePaymentModal()">
        </app-queue-payment>

        <div class="error" *ngIf="songError">
          âš ï¸ {{ songError }}
        </div>
      </section>

    </main>
  </div>

</div>